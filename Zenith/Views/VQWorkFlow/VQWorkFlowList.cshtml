@model IEnumerable<Zenith.BLL.DTO.VendorQualificationWorkFlowDTO>
@{
    ViewData["Title"] = "WorkFlow Steps ";
}

<style>
    .title {
        color: #00387f;
        font-weight: 600;
        text-align: center;
        margin-bottom: 40px;
    }

        .title span {
            color: #C72C1C;
        }

    .btn-delete {
        background-color: #e74c3c; /* Red background */
        color: #fff; /* White text */
        font-weight: bold;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        transition: background-color 0.3s ease, transform 0.2s ease;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2); /* Subtle shadow */
    }

        .btn-delete:hover {
            background-color: #c0392b; /* Darker red on hover */
            transform: scale(1.05); /* Slight scale up on hover */
            box-shadow: 0px 6px 8px rgba(0, 0, 0, 0.3); /* More shadow on hover */
        }

        .btn-delete:active {
            background-color: #a93226; /* Even darker red on click */
            transform: scale(0.98); /* Scale down on click */
        }
</style>

<div class="container-fluid">
    <div class="row">
        <!-- sidebar -->
        <div class="col-md-3 col-lg-2 px-0 shadow-sm sidebar">
            <partial name="_Sidebar" />
        </div>

        <div class="col-md-9 col-lg-10 ml-md-auto mt-3">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="py-2 mb-0 title"><span> @ViewBag.WorkFlowName </span></h1>
                    <div>
                        <button class="btn btn-outline-info text-dark" data-bs-toggle="modal" data-bs-target="#addworkflow"><i class="fas fa-plus"></i> Add WorkFlow Step</button>
                        <button class="btn btn-delete" onclick="deleteSelectedUsers()">Delete WorkFlow Steps</button>
                    </div>
                </div>
                <div class="mt-3" style="overflow:auto;height:590px">
                    <table class="table table-striped table-bordered" style="width:125%">
                        <thead class="bg-primary text-white text-center text-nowrap">
                            <tr>
                                <th><input type="checkbox" onchange="selectAllChkbxChangeEvent(this)" /></th>
                                <th><b>Security Group Name </b></th>
                                <th><b>Role Name</b></th>
                                <th><b>Step Order</b></th>
                                <th><b>Step Name</b></th>
                                <th><b>Description</b></th>
                                <th><b>IsActive</b></th>
                                <th><b>Is Critical</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int index = 1;
                                @foreach (var workFlow in Model)
                                {
                                    <tr>
                                        <td class="text-right">
                                            <input type="checkbox" UserId="@workFlow.Id" class="actionCheckboxes" />
                                        </td>
                                        <td class="text-center"></td>
                                        <td class="text-center">
                                            <a title="View" target="_blank" class="nav-link" asp-controller="VQWorkFlow" asp-action="VQWorkFlowViewDetail" asp-route-vendorQualificationWorkFlowId="@workFlow.Id">
                                                @workFlow.RoleName
                                            </a>
                                        </td>
                                        <td class="text-center">@workFlow.StepOrder</td>
                                        <td class="text-center">@workFlow.StepName</td>
                                        <td class="text-center">@workFlow.Description</td>
                                        <td class="text-center">
                                            @if (workFlow.IsActive)
                                            {
                                                <input type="checkbox" checked disabled />
                                            }
                                            else
                                            {
                                                <input type="checkbox" disabled />
                                            }
                                        </td>
                                        <td class="text-center">
                                            @if (workFlow.IsCriticalOnly)
                                            {
                                                <input type="checkbox" checked disabled />
                                            }
                                            else
                                            {
                                                <input type="checkbox" disabled />
                                            }
                                        </td>
                                    </tr>
                                    index++;
                                }
                            }

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@* Modal *@

<!-- Add User -->
<div class="modal fade" id="addworkflow" tabindex="-1" aria-labelledby="addworkflowLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:100%;max-width:768px">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addworkflowLabel">Add New WorkFlow Step</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addWorkFlowForm" method="post">
                    <div class="row">
                        <div class="form-group col-md-6 mt-2">
                            <label>Security Group Name <span class="text-danger fw-bold">*</span></label>
                            <select class="form-select mt-2 SecurityGroupId" name="Role" onblur="validateForm(this.value,true,'requiredRole')">  </select>
                            <span class="text-danger" id="requiredSecurityGroupId" style="display:none">This field is required</span>
                        </div>
                        <div class="form-group col-md-6 mt-2">
                            <label>Role Name <span class="text-danger fw-bold">*</span></label>
                            <select class="form-select mt-2 roleSelect" name="Role" onblur="validateForm(this.value,true,'requiredRole')">  </select>
                            <span class="text-danger" id="requiredRoleId" style="display:none">This field is required</span>
                        </div>
                        <div class="form-group col-md-6 mt-2">
                            <label>StepOrder <span class="text-danger fw-bold">*</span></label>
                            <input type="number" class="form-control mt-2 StepOrder" name="StepOrder" min="1" placeholder="Step Order" />
                            <span class="text-danger" id="StepOrderErrorMessage" style="display:none">Please enter valid email</span>
                        </div>
                        @* <div class="form-group col-md-6 mt-2">
                            <label>StepName <span class="text-danger fw-bold">*</span></label>
                            <input type="text" onblur="validateForm(this.value,true,'StepName')" class="form-control mt-2 StepName" name="StepName" placeholder="Step Name" />
                            <span class="text-danger" id="StepNameError" style="display:none">This field is required</span>
                        </div> *@
                        <div class="form-group col-md-6 mt-2">
                            <label>StepName <span class="text-danger fw-bold">*</span></label>
                            <select class="editFormFields form-select mt-2 StepName" name="StepName" onblur="validateForm(this.value,true,'StepNameError')">
                                @if (ViewBag.WorkFlowStpes != null)
                                {
                                    foreach (var c in ViewBag.WorkFlowStpes)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                }
                                else
                                {
                                    <option value="">No Steps Available</option>
                                }
                            </select>
                            <span class="text-danger" id="StepNameError" style="display:none">This field is required</span>
                        </div>
                        <div class="form-group col-md-6 mt-2">
                            <label>Description <span class="text-danger fw-bold">*</span></label>
                            <input type="text" onblur="validateForm(this.value,true,'Description')" class="form-control mt-2 Description" name="Description" placeholder="Description" />
                            <span class="text-danger" id="DescriptionError" style="display:none">This field is required</span>
                        </div>
                        <div class="form-group col-md-6 mt-2">
                            <label for="IsActive" class="form-label">
                                Is Active <span class="text-danger fw-bold">*</span>
                            </label>
                            <input type="checkbox"
                                   id="IsActive"
                                   class="form-check-input isactive"
                                   name="IsActive" />
                        </div>
                        <div class="form-group col-md-6 mt-2">
                            <label for="IsCriticalOnly" class="form-label">
                                Is Critical <span class="text-danger fw-bold">*</span>
                            </label>
                            <input type="checkbox"
                                   id="IsCriticalOnly"
                                   class="form-check-input iscriticalonly"
                                   name="IsCriticalOnly" />
                        </div>
                    </div>
                    <div class="modal-footer mt-3">
                        <button type="button" class="btn btn-primary" onclick="addWorkFlow('@(ViewBag.workFlowId ?? "")' )">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="~/lib/jquery/common.js"></script>
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script>
    getRols();

    function getRols() {
        $.ajax({
            url: '/AppRoles/GetRoles',
            type: 'GET',
            dataType: "json",
            success: function (res) {
                let data = `
                                       <option value=''>Select</option>
                                       ${res.map(option => `<option value='${option.id}'>${option.name}</option>`)}
                                    `;
                $('.roleSelect').append(data);
            }
        });
    }

    //Update user funtion
    function addWorkFlow(WorkFlowsId) {
        let SecurityGroupId = $('#addWorkFlowForm .SecurityGroupId').val();
        let roleSelect = $('#addWorkFlowForm .roleSelect').val();
        let stepOrder = $('#addWorkFlowForm .StepOrder').val();
        let StepName = $('#addWorkFlowForm .StepName').val();
        let Description = $('#addWorkFlowForm .Description').val();
        let isactive = $('#addWorkFlowForm .isactive').prop('checked');
        let iscriticalonly = $('#addWorkFlowForm .iscriticalonly').prop('checked');

        if (/* (!validateForm(SecurityGroupId, true, 'requiredSecurityGroupId'))  || */ (!validateForm(roleSelect, true, 'requiredRoleId')) || (!validateForm(stepOrder, true, 'StepOrderErrorMessage')) || (!validateForm(StepName, true, 'StepNameError'))
            || (!validateForm(Description, true, 'DescriptionError')) )
            return false;

        $.ajax({
            url: '/VQWorkFlow/AddVQWorkFlow',
            type: 'POST',
            data: {
                WorkFlowsId: WorkFlowsId,
                SecurityGroupId: SecurityGroupId,
                roleId: roleSelect,
                stepOrder: stepOrder,
                StepName: StepName,
                Description: Description,
                isactive: isactive,
                iscriticalonly: iscriticalonly,
            },
            success: function (resp) {
                window.location.reload();
            }
        });
    }

    function selectAllChkbxChangeEvent(thisEvent) {
        $(".actionCheckboxes").each(function () {
            $(this).prop('checked', $(thisEvent).is(":checked"));
        });
    }

    function deleteSelectedUsers() {

        let selectedGuids = [];

        // Loop through checked checkboxes with class 'actionCheckboxes'
        $(".actionCheckboxes:checked").each(function () {
            // Push the checkbox value (assumed to be a GUID string) to the array
            selectedGuids.push($(this).attr('UserId'));
        });

        if(selectedGuids.length === 0){
            Swal.fire({
                icon : "warning",
                text : "Please select a record to delete.",
                showConfirmButton : true,
            });
            return;
        }

        Swal.fire({
            title: 'Are you sure?',
            text: 'Do you really want to delete the selected workflow steps?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'No, cancel',
        }).then((result) => {
            if (result.value === true) {
                $.ajax({
                    type: "POST",
                    url: "/VQWorkFlow/DeleteVQWorkFlow",
                    data: JSON.stringify(selectedGuids),
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                            if (response.isSuccess) {
                                Swal.fire({
                                    icon: "success",
                                    text: "Selected workflow steps deleted successfully!",
                                    showConfirmButton: false,
                                    timer: 1500,
                                }).then(() => {
                                   window.location.reload();
                                });
                            } else if (response.partiallySuccess) {
                                Swal.fire({
                                    icon: "info",
                                    title: "Deletion Failed",
                                html: `Selected workflow steps could not be deleted, Please deactivate them :${response.notDeletedVQWorkFlowNames.map(w => `${w}`).join(', ')}`,
                                    showConfirmButton: true,
                                }).then(() => {
                                    window.location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: "error",
                                    title: "Deletion Failed",
                                    text: `The following Vendor Qualification workflows cannot be deleted. Please deactivate them:${response.notDeletedVQWorkFlowNames.map(w => `${w}`).join(', ')}`,
                                    showConfirmButton: true,
                                    });
                                }
                            },
                    error: function () {
                            Swal.fire({
                                 icon: "error",
                                 text: "An error occurred. Please try again.",
                                 showConfirmButton: true,
                            });
                    }
                });
            }
        });
    }

</script>